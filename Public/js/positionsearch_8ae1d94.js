define("merchants:widget/settled/position/positionSearch/positionSearch.js",function(require,exports,module){function PositionSearch(t){this.wrap=t,this.wrap.html(WRAP_TMPL()),this.wrap.addClass("widget-merchants-settled-position-search"),this.form=this.wrap.find("form"),this.$searchInput=this.wrap.find("[data-node=searchPosition]"),this.$sugWrapper=this.$searchInput.siblings(".sugList"),this.errMsg="请输入有效位置",this.cid="",this.is_open=!1,this.coordinate="",this.initEvent()}var SEARCH_POSITION_URL="/waimai?qt=poisug",WRAP_TMPL=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<form><input type="text" placeholder="请输入商户位置/小区/大厦/学校" name="poi_name"  data-node="searchPosition" autocomplete="off"/><button type="submit">搜索</button><ul class="sugList positionList" data-node="allPositionList"></ul></form>'),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0];PositionSearch.prototype={initEvent:function(){var t=this;this.$searchInput.on("keyup",function(e){13!=e.keyCode&&40!=e.keyCode&&38!=e.keyCode&&$.when(t.getSugData()).done(function(e){0==e.s.length?t.hideSugs():t.showSugs(e.s)}).fail(function(){})}),this.$searchInput.on("keydown",function(e){var i=$(".sug-wrapper li"),n=t.getCurrIndex();if(13==e.keyCode)e.preventDefault(),t.form.submit();else if(40==e.keyCode){if(e.preventDefault(),!t.isSugsShow())return;n<t.getSugLength()-1?++n:n=0;var r=t.getSugAtIndex(n);t.setInputValue(r.text()),t.setCurrSug(r)}else if(38==e.keyCode){if(e.preventDefault(),!t.isSugsShow())return;n>0?n--:n=i.length-1;var r=t.getSugAtIndex(n);t.setInputValue(r.text()),t.setCurrSug(r)}}),this.$sugWrapper.delegate("li","mousemove",function(){t.setCurrSug($(this))}),this.$sugWrapper.delegate("li","mouseout",function(){t.cancelCurrSug($(this))}),this.$sugWrapper.delegate("li","click",function(){t.setInputValue($(this).text()),t.setCurrSug($(this)),t.hideSugs()}),this.form.on("submit",function(){return t.hideSugs(),listener.trigger("position","selectposition",{is_open:t.is_open,city:t.city,city_id:t.cid,wd:t.$searchInput.val()}),!1})},showSugs:function(t){for(var e="",i=0;i<t.length;i++){var n=t[i].split("$");e+='<li data-coordinate="'+n[5]+'">'+n[3]+"</li>"}this.$sugWrapper.empty().html(e).show()},hideSugs:function(){this.$sugWrapper.hide()},isSugsShow:function(){return!("none"==this.$sugWrapper.css("display"))},setCurrSug:function(t){var e=this.$sugWrapper.find("li");e.removeClass("curr"),t.addClass("curr")},cancelCurrSug:function(t){t.removeClass("curr")},getCurrIndex:function(){var t=this.$sugWrapper.find("li");return t.index(this.$sugWrapper.find("li.curr"))},setInputValue:function(t){this.$searchInput.val(t)},getSugLength:function(){return this.$sugWrapper.find("li").length},getSugAtIndex:function(t){return this.$sugWrapper.find("li").eq(t)},getSugData:function(){var t=this,e=$.Deferred();return $.ajax({url:SEARCH_POSITION_URL,method:"post",dataType:"json",data:{wd:$.trim(t.$searchInput.val()),type:0,from:"pc",cid:t.cid},success:function(t){e.resolve(t)},error:function(){e.reject()}}),e},toggleDisable:function(t,e,i){this.cid=e,this.is_open=t,this.city=i},validate:function(){var t=this,e=[],i=[],n=$.Deferred();return this.is_open?$.when(t.getSugData()).done(function(r){for(var s=0;s<r.s.length;s++){var a=r.s[s].split("$");e.push(a[3]),i.push(a[5])}var u=e.indexOf($.trim(t.$searchInput.val()));u>-1?(t.coordinate=i[u],n.resolve()):n.reject("请选择合理的店铺位置")}).fail(function(){}):n.resolve(),n},getData:function(){var t=this,e={};return this.is_open&&(e.poi_name=t.$searchInput.val(),e.latitude=t.coordinate.split(",")[0],e.longitude=t.coordinate.split(",")[1]),e}},module.exports=PositionSearch});