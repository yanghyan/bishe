!function(i){function n(n){return i.inArray(n.toLocaleLowerCase(),u)>-1}function e(n,e,a,l){if(l&&l.url)var r=l.url;else var r=0/0;a.find(".loading").removeClass("hide"),t(a,!1),i.ajax({url:r,files:a.find("[type=file]"),iframe:!0,dataType:"json",success:function(i){return a.find(".loading").addClass("hide"),i.errno?(d(null,i.errmsg||"上传失败。"),void n.val("")):void e(i.url)},error:function(i){d(a,i)}}).complete(function(){})}function t(i,n){n?i.find(".upload-btn").addClass("empty"):i.find(".upload-btn").removeClass("empty")}function a(i){var n=i.attr("input-name"),e=i.data("title"),t=i.attr("data-url"),a=u.map(function(i){return"."+i}).join(","),d='<div class="upload-preview hide" >                        <img class="simg" title="logo" width="150" height="125">                    </div>                    <div class="upload-btn empty">                        <div class="btn add-long">点击上传'+e+'图</div>                        <div class="btn add">上传</div>                        <input type="file" name="file" value="上传" accept="'+a+'"/>                        <input type="hidden" data-node="imgUrl">                        <div class="btn del">删除</div>                    </div>                    <div class="upload-loading hide loading"><img></div>';i.html(d),i.find("input:file"),i.find("input:hidden").attr("name",n),i.find("input:hidden").attr("value",t),i.find(".loading").find("img").attr("src","//stb0.waimai.baidu.com/static/merchants/images/loading_0e6e0f4.gif"),t&&i.find(".upload-preview").removeClass("hide").find("img").attr("src",t)}function d(i,n){alert(n||"上传失败")}function l(i,n,e,t){var a="",n=n||150,e=e||125,t=t||"s_0",d=parseInt(3*Math.random(),10);return i?a=/^(http|https):\/\/img.waimai.bdimg.com\/.*$/gi.test(i)?i+"@"+t+",w_"+n+",h_"+e:"http://webmap"+d+".map.bdimg.com/maps/services/thumbnails?align=center,center&quality=100&width="+n+"&height="+e+"&src="+encodeURIComponent(i):""}function r(i,n){n?i.addClass("has-del"):i.removeClass("has-del")}function s(n,a){n.find("input:file").change(function(t){t.preventDefault();var d=i(this),l=d.val();i.when(o(l)).done(function(){var l=t.target.files[0];a.validatImageSize&&(f=a.validatImageSize),i.when(f(l)).then(function(){n.find("input:hidden").val("").change(),e(d,function(i){n.find("input:hidden").val(i).change()},n,a)},function(){d.val("")})})}),n.find("input:hidden").change(function(){var e=i(this).val();e&&(e&&!e.indexOf("http")?(n.find("a").attr("href",e).unbind().click(function(i){i.stopPropagation(),i.preventDefault()}),n.find(".simg").attr("src",l(e)).closest("div").removeClass("hide"),r(n,!0)):n.find(".simg").closest("div").addClass("hide"))}),n.find(".btn.del").click(function(){n.find(".simg").attr("src","").closest("div").addClass("hide"),n.find("input:file").val(""),n.find("input:hidden").val(""),n.find(".upload-btn").removeClass("empty"),r(n,!1),t(n,!0)})}function o(e){var t=new i.Deferred;if(e.length){var a=e.split(".");if(a.length&&(a=a[a.length-1],a.length)){if(n(a))return void t.resolve();alert("不支持此种格式的图片。")}}return t.reject(),t}function f(){var n=new i.Deferred;return n.resolve(),n}var u=["jpg","jpeg","png","bmp"];i.fn.uploadImg=function(n){this.each(function(){var e=i(this);a(e,n),s(e,n)})}}(jQuery);